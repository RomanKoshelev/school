name: Enable GitHub Pages

on:
  push:
    branches: ["claude/*"]
    paths: [".github/workflows/enable-pages.yml", "docs/**"]

permissions:
  contents: write
  pages: write

jobs:
  configure-pages:
    runs-on: ubuntu-latest
    steps:
      - name: Configure Pages to use gh-pages branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          API="https://api.github.com/repos/$REPO/pages"
          AUTH="Authorization: Bearer $GH_TOKEN"
          ACCEPT="Accept: application/vnd.github+json"

          echo "=== Current Pages config ==="
          curl -s -H "$AUTH" -H "$ACCEPT" "$API" || true

          echo ""
          echo "=== Setting source to gh-pages branch ==="
          # Try to update existing Pages config
          RESULT=$(curl -s -w "\n%{http_code}" -X PUT \
            -H "$AUTH" -H "$ACCEPT" \
            "$API" \
            -d '{"source":{"branch":"gh-pages","path":"/"}}')

          HTTP_CODE=$(echo "$RESULT" | tail -1)
          BODY=$(echo "$RESULT" | head -n -1)
          echo "HTTP $HTTP_CODE"
          echo "$BODY"

          # If 404, Pages doesn't exist yet - create it
          if [ "$HTTP_CODE" = "404" ]; then
            echo ""
            echo "=== Creating Pages site ==="
            curl -s -X POST \
              -H "$AUTH" -H "$ACCEPT" \
              "$API" \
              -d '{"source":{"branch":"gh-pages","path":"/"}}'
          fi

          echo ""
          echo "=== Final Pages config ==="
          curl -s -H "$AUTH" -H "$ACCEPT" "$API"

  deploy-content:
    needs: configure-pages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: gh-pages

      - uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
